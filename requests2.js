console.log('‚úÖ requests2.js started loading');

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è API_BASE
function getApiBase() {
    // –ï—Å–ª–∏ window.location –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å
    if (typeof window === 'undefined' || !window.location) {
        return '/api';
    }
    return window.location.origin + '/api';
}

// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showRequestForm() {
    console.log('üìù Show request form called');
    const form = document.getElementById("request-form");
    if (form) {
        form.classList.remove("hidden");
        console.log('‚úÖ Form shown');
    }
}

function submitRequest() {
    console.log('üì§ Submit request called');
    
    // –ü–æ–ª—É—á–∞–µ–º API_BASE –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
    const API_BASE = getApiBase();
    console.log('Using API Base:', API_BASE);
    
    const title = document.getElementById("request-title").value.trim();
    const description = document.getElementById("request-description").value.trim();
    const priority = document.getElementById("request-priority").value;
    
    if (!title || !description) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.");
        return;
    }
    
    const userKey = localStorage.getItem('userKey');
    if (!userKey) {
        alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
        return;
    }
    
    fetch(API_BASE + '/requests', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': userKey
        },
        body: JSON.stringify({ title, description, priority })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
            resetForm();
            displayRequests();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    });
}
function resetForm() {
    console.log(' resetForm called');
    document.getElementById("request-title").value = "";
    document.getElementById("request-description").value = "";
    document.getElementById("request-form").classList.add("hidden");
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞—è–≤–æ–∫
async function displayRequests() {
    const API_BASE = getApiBase();
    console.log(' Displaying requests');
    const container = document.getElementById("requests-container");
    
    if (!container) {
        console.error(' Container not found');
        return;
    }
    
    const userKey = localStorage.getItem('userKey');
    if (!userKey) {
        container.innerHTML = '<div class="no-requests">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞—è–≤–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</div>';
        return;
    }
    
    try {
        const response = await fetch('http://localhost:3000/api/requests', {
            headers: {
                'Authorization': userKey
            }
        });
        
        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫');
        }
        
        const requests = await response.json();
        console.log('üì• Loaded requests:', requests);
        
        if (requests.length === 0) {
            container.innerHTML = '<div class="no-requests">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
            return;
        }
        
        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        container.innerHTML = '';
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞—è–≤–∫–∏
        requests.forEach(request => {
            const requestElement = document.createElement('div');
            requestElement.className = `request priority-${request.priority} status-${request.status}`;
            requestElement.innerHTML = `
                <div class="request-header">
                    <h4>${request.title}</h4>
                    <span class="status-badge status-${request.status}">${getStatusText(request.status)}</span>
                </div>
                <p>${request.description}</p>
                <div class="request-footer">
                    <div class="request-meta">
                        <small>–°–æ–∑–¥–∞–Ω–æ: ${new Date(request.created_at).toLocaleString('ru-RU')}</small>
                        <small>–ê–≤—Ç–æ—Ä: <strong>${request.username}</strong></small>
                        <small>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${getPriorityText(request.priority)}</small>
                    </div>
                    <div class="request-actions">
                        <button onclick="deleteRequest(${request.id})" class="btn-delete">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `;
            container.appendChild(requestElement);
        });
        
    } catch (error) {
        console.error('Error loading requests:', error);
        container.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</div>';
    }
}

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏
async function deleteRequest(id) {
    const API_BASE = getApiBase();
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) return;
    
    const userKey = localStorage.getItem('userKey');
    if (!userKey) return;
    
    try {
        const response = await fetch(`http://localhost:3000/api/requests/${id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': userKey
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('–ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
            displayRequests(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (error) {
        console.error('Error deleting request:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getStatusText(status) {
    const statusMap = {
        'new': ' –ù–æ–≤–∞—è',
        'in-progress': ' –í —Ä–∞–±–æ—Ç–µ',
        'completed': ' –ó–∞–≤–µ—Ä—à–µ–Ω–∞',
        'rejected': ' –û—Ç–∫–ª–æ–Ω–µ–Ω–∞'
    };
    return statusMap[status] || status;
}

function getPriorityText(priority) {
    const priorityMap = {
        'low': ' –ù–∏–∑–∫–∏–π',
        'medium': ' –°—Ä–µ–¥–Ω–∏–π', 
        'high': ' –í—ã—Å–æ–∫–∏–π',
        'critical': ' –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π'
    };
    return priorityMap[priority] || priority;
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Page loaded, displaying requests...');
    displayRequests();
});

// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
window.showRequestForm = showRequestForm;
window.submitRequest = submitRequest;
window.resetForm = resetForm;
window.displayRequests = displayRequests;
window.deleteRequest = deleteRequest;

console.log('üéâ requests.js loaded successfully');
